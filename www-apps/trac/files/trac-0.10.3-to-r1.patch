Index: wiki-default/WikiStart
===================================================================
--- wiki-default/WikiStart	(.../tags/trac-0.10.3)	(revision 4460)
+++ wiki-default/WikiStart	(.../branches/0.10-stable)	(revision 4460)
@@ -1,4 +1,4 @@
-= Welcome to Trac 0.10.3 =
+= Welcome to Trac 0.10.3dev =
 
 Trac is a '''minimalistic''' approach to '''web-based''' management of
 '''software projects'''. Its goal is to simplify effective tracking and handling of software issues, enhancements and overall progress.
Index: trac/attachment.py
===================================================================
--- trac/attachment.py	(.../tags/trac-0.10.3)	(revision 4460)
+++ trac/attachment.py	(.../branches/0.10-stable)	(revision 4460)
@@ -447,7 +447,9 @@
         if hasattr(upload.file, 'fileno'):
             size = os.fstat(upload.file.fileno())[6]
         else:
-            size = upload.file.len
+            upload.file.seek(0, 2) # seek to end of file
+            size = upload.file.tell()
+            upload.file.seek(0)
         if size == 0:
             raise TracError("Can't upload empty file")
 
Index: trac/db_default.py
===================================================================
--- trac/db_default.py	(.../tags/trac-0.10.3)	(revision 4460)
+++ trac/db_default.py	(.../branches/0.10-stable)	(revision 4460)
@@ -273,7 +273,7 @@
    (CASE status 
       WHEN 'closed' THEN 'color: #777; background: #ddd; border-color: #ccc;'
       ELSE 
-        (CASE owner WHEN '$USER' THEN 'font-weight: bold' END)
+        (CASE owner WHEN $USER THEN 'font-weight: bold' END)
     END) AS __style__,
    id AS ticket, summary, component, status, 
    resolution,version, t.type AS type, priority, owner,
@@ -300,7 +300,7 @@
    reporter AS _reporter
   FROM ticket t
   LEFT JOIN enum p ON p.name = t.priority AND p.type = 'priority'
-  WHERE t.status IN ('new', 'assigned', 'reopened') AND owner = '$USER'
+  WHERE t.status IN ('new', 'assigned', 'reopened') AND owner = $USER
   ORDER BY (status = 'assigned') DESC, p.value, milestone, t.type, time
 """),
 #----------------------------------------------------------------------------
@@ -312,7 +312,7 @@
 """
 SELECT p.value AS __color__,
    (CASE owner 
-     WHEN '$USER' THEN 'My Tickets' 
+     WHEN $USER THEN 'My Tickets' 
      ELSE 'Active Tickets' 
     END) AS __group__,
    id AS ticket, summary, component, version, milestone, t.type AS type, 
@@ -323,7 +323,7 @@
   FROM ticket t
   LEFT JOIN enum p ON p.name = t.priority AND p.type = 'priority'
   WHERE status IN ('new', 'assigned', 'reopened') 
-  ORDER BY (owner = '$USER') DESC, p.value, milestone, t.type, time
+  ORDER BY (owner = $USER) DESC, p.value, milestone, t.type, time
 """ % owner))
 
 
Index: trac/ticket/report.py
===================================================================
--- trac/ticket/report.py	(.../tags/trac-0.10.3)	(revision 4460)
+++ trac/ticket/report.py	(.../branches/0.10-stable)	(revision 4460)
@@ -453,24 +453,32 @@
             req.hdf['report.var.' + aname] = arg
             values.append(arg)
 
+        var_re = re.compile("[$]([A-Z]+)")
+
         # simple parameter substitution outside literal
         def repl(match):
             add_value(match.group(1))
             return '%s'
 
         # inside a literal break it and concatenate with the parameter
-        def repl_literal(match):
-            add_value(match.group(1))
-            return db.concat("'", "%s", "'")
+        def repl_literal(expr):
+            parts = var_re.split(expr[1:-1])
+            if len(parts) == 1:
+                return expr
+            params = parts[1::2]
+            parts = ["'%s'" % p for p in parts]
+            parts[1::2] = ['%s'] * len(params)
+            for param in params:
+                add_value(param)
+            return db.concat(*parts)
 
-        var_re = re.compile("[$]([A-Z]+)")
         sql_io = StringIO()
 
         # break SQL into literals and non-literals to handle replacing
         # variables within them with query parameters
         for expr in re.split("('(?:[^']|(?:''))*')", sql):
             if expr.startswith("'"):
-                sql_io.write(var_re.sub(repl_literal, expr))
+                sql_io.write(repl_literal(expr))
             else:
                 sql_io.write(var_re.sub(repl, expr))
         return sql_io.getvalue(), values
Index: trac/ticket/tests/report.py
===================================================================
--- trac/ticket/tests/report.py	(.../tags/trac-0.10.3)	(revision 4460)
+++ trac/ticket/tests/report.py	(.../branches/0.10-stable)	(revision 4460)
@@ -1,3 +1,4 @@
+from trac.db.mysql_backend import MySQLConnection
 from trac.ticket.report import ReportModule
 from trac.test import EnvironmentStub, Mock
 from trac.web.api import Request, RequestDone
@@ -4,6 +5,11 @@
 
 import unittest
 
+class MockMySQLConnection(MySQLConnection):
+    def __init__(self):
+        pass
+
+
 class ReportTestCase(unittest.TestCase):
 
     def setUp(self):
@@ -24,6 +30,16 @@
         self.assertEqual("''||%s||''", sql)
         self.assertEqual(['value'], args)
 
+    def test_sub_var_mysql(self):
+        req = Mock(hdf=dict())
+        env = EnvironmentStub()
+        env.db = MockMySQLConnection()
+        sql, args = ReportModule(env).sql_sub_vars(req, "'$VAR'",
+                                                   {'VAR': 'value'})
+        self.assertEqual("concat('', %s, '')", sql)
+        self.assertEqual(['value'], args)
+
+
 def suite():
     return unittest.makeSuite(ReportTestCase, 'test')
 
Index: trac/__init__.py
===================================================================
--- trac/__init__.py	(.../tags/trac-0.10.3)	(revision 4460)
+++ trac/__init__.py	(.../branches/0.10-stable)	(revision 4460)
@@ -11,7 +11,7 @@
 """
 __docformat__ = 'epytext en'
 
-__version__ = '0.10.3'
+__version__ = '0.10.3dev'
 __url__ = 'http://trac.edgewall.org/'
 __copyright__ = '(C) 2003-2006 Edgewall Software'
 __license__ = 'BSD'
Index: trac/versioncontrol/svn_fs.py
===================================================================
--- trac/versioncontrol/svn_fs.py	(.../tags/trac-0.10.3)	(revision 4460)
+++ trac/versioncontrol/svn_fs.py	(.../branches/0.10-stable)	(revision 4460)
@@ -293,7 +293,7 @@
         self.fs_ptr = repos.svn_repos_fs(self.repos)
         
         uuid = fs.get_uuid(self.fs_ptr, self.pool())
-        name = 'svn:%s:%s' % (uuid, path)
+        name = 'svn:%s:%s' % (uuid, _from_svn(path))
 
         Repository.__init__(self, name, authz, log)
 
Index: trac/versioncontrol/cache.py
===================================================================
--- trac/versioncontrol/cache.py	(.../tags/trac-0.10.3)	(revision 4460)
+++ trac/versioncontrol/cache.py	(.../branches/0.10-stable)	(revision 4460)
@@ -56,6 +56,8 @@
         cursor.execute("SELECT value FROM system WHERE name='repository_dir'")
         for previous_repository_dir, in cursor:
             if previous_repository_dir != self.name:
+                self.log.info("'repository_dir' has changed from %r to %r"
+                              % (previous_repository_dir, self.name))
                 raise TracError("The 'repository_dir' has changed, "
                                 "a 'trac-admin resync' operation is needed.")
             break
Index: trac/scripts/tests/admin-tests.txt
===================================================================
--- trac/scripts/tests/admin-tests.txt	(.../tags/trac-0.10.3)	(revision 4460)
+++ trac/scripts/tests/admin-tests.txt	(.../branches/0.10-stable)	(revision 4460)
@@ -1,5 +1,5 @@
 ===== test_help_ok =====
-trac-admin - The Trac Administration Console 0.10.3
+trac-admin - The Trac Administration Console 0.10.3dev
 
 Usage: trac-admin </path/to/projenv> [command [subcommand] [option ...]]
 

Property changes on: .
___________________________________________________________________
Name: svnmerge-integrated
   - /trunk:1-3801,3805-3810,3814-3823,3830-3831,3833,3837-3839,3841-3846,3850-3851,3854-3856,3858-3863,3869-3880,3886,3888-3891,3893-3896,3901,3914,3919-3922,3924,3926-3934,3944,3949,3971,3973,3980-3981,3984-3985,3994-3995,3998,4013,4019,4028,4030,4033,4035-4036,4040,4042-4044,4046-4049,4051-4062,4064-4065,4068-4073,4079-4081,4084,4088-4093,4099-4100,4102-4103,4105-4108,4110-4112,4117-4129,4131-4132,4134,4144-4149,4151-4158,4160-4164,4166-4168,4171,4174-4181,4183-4188,4190,4192-4198,4200-4201,4205-4207,4209-4210,4216-4217,4233-4235,4240-4241,4243-4244,4247-4249,4252,4254-4257,4265-4274,4276-4277,4279-4280,4283-4284,4298-4301,4303,4306-4315,4317-4321,4323-4327,4329-4330,4332,4337,4341,4349,4362,4379,4384,4433
   + /trunk:1-3801,3805-3810,3814-3823,3830-3831,3833,3837-3839,3841-3846,3850-3851,3854-3856,3858-3863,3869-3880,3886,3888-3891,3893-3896,3901,3914,3919-3922,3924,3926-3934,3944,3949,3971,3973,3980-3981,3984-3985,3994-3995,3998,4013,4019,4028,4030,4033,4035-4036,4040,4042-4044,4046-4049,4051-4062,4064-4065,4068-4073,4079-4081,4084,4088-4093,4099-4100,4102-4103,4105-4108,4110-4112,4117-4129,4131-4132,4134,4144-4149,4151-4158,4160-4164,4166-4168,4171,4174-4181,4183-4188,4190,4192-4198,4200-4201,4205-4207,4209-4210,4216-4217,4233-4235,4240-4241,4243-4244,4247-4249,4252,4254-4257,4265-4274,4276-4277,4279-4280,4283-4284,4298-4301,4303,4306-4315,4317-4321,4323-4327,4329-4330,4332,4337,4341,4349,4362,4379,4384,4433,4453,4459

